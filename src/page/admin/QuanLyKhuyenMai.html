<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang Qu·∫£n L√Ω Khuy·∫øn M√£i - SkyDrone</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <link rel="stylesheet" href="../../stylesheets/admin/QuanLyKhuyenMai.css">


</head>
<body>

<!-- ===== THANH TI√äU ƒê·ªÄ ===== -->
<header class="tieu-de-chinh">
    <div class="logo">SkyDrone Admin</div>
    <div class="ben-phai">
        <button class="nut-dang-xuat" title="ƒêƒÉng xu·∫•t">
            <i class="bi bi-box-arrow-right"></i>
        </button>
    </div>
</header>

<!-- ===== B·ªê C·ª§C CH√çNH ===== -->
<div class="bo-cuc">
    <!-- === THANH MENU B√äN TR√ÅI === -->
    <aside class="sidebar">
        <div class="user-info">
            <img src="https://i.pravatar.cc/80" alt="Avatar">
            <h3>M·∫°c Nguy√™n</h3>
            <p>Ch√†o m·ª´ng b·∫°n tr·ªü l·∫°i üëã</p>
        </div>

        <ul class="menu">
            <li><i class="bi bi-speedometer2"></i> B·∫£ng ƒêi·ªÅu Khi·ªÉn</li>
            <li><i class="bi bi-person-lines-fill"></i> Qu·∫£n L√Ω T√†i Kho·∫£n</li>
            <li class="active"><i class="bi bi-box-seam"></i> Qu·∫£n L√Ω S·∫£n Ph·∫©m</li>
            <li><i class="bi bi-tags"></i> Qu·∫£n L√Ω Danh M·ª•c</li>

            <li class="has-submenu">
                <div class="menu-item">
                    <i class="bi bi-truck"></i>
                    <span>Qu·∫£n L√Ω ƒê∆°n H√†ng</span>
                    <i class="bi bi-chevron-right arrow"></i>
                </div>
                <ul class="submenu">
                    <li>Ch∆∞a X√°c Nh·∫≠n</li>
                    <li>ƒê√£ X√°c Nh·∫≠n</li>
                </ul>
            </li>

            <li><i class="bi bi-megaphone"></i> Qu·∫£n L√Ω Khuy·∫øn M√£i</li>
            <li><i class="bi bi-bar-chart"></i> B√°o C√°o & Th·ªëng K√™</li>
        </ul>
    </aside>


    <!-- === N·ªòI DUNG CH√çNH === -->
    <main class="noi-dung-chinh container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-primary fw-bold"><i class="bi bi-megaphone"></i> Qu·∫£n L√Ω Khuy·∫øn M√£i</h4>
            <button class="btn btn-success nut-them" data-bs-toggle="modal" data-bs-target="#hopThoaiKhuyenMai">
                <i class="bi bi-plus-lg"></i> Th√™m Khuy·∫øn M√£i
            </button>
        </div>


        <!-- === B·∫¢NG DANH S√ÅCH KHUY·∫æN M√ÉI === -->
        <table id="bangKhuyenMai" class="table table-striped table-bordered">
            <thead class="table-primary">
            <tr>
                <th>M√£ KM</th>
                <th>T√™n Ch∆∞∆°ng Tr√¨nh</th>
                <th>M·ª©c Gi·∫£m</th>
                <th>Th·ªùi Gian √Åp D·ª•ng</th>
                <th>Ph·∫°m Vi √Åp D·ª•ng</th>
                <th>Thao T√°c</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>KM001</td>
                <td>Gi·∫£m 20% to√†n b·ªô Drone</td>
                <td>20%</td>
                <td>2025-11-01 - 2025-11-15</td>
                <td>To√†n b·ªô s·∫£n ph·∫©m</td>
                <td>
                    <button class="btn btn-warning btn-sm nut-sua"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm nut-xoa"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
            <tr>
                <td>KM002</td>
                <td>Gi·∫£m 500k cho Drone quay phim</td>
                <td>500.000ƒë</td>
                <td>2025-11-05 - 2025-11-20</td>
                <td>Danh m·ª•c Drone quay phim</td>
                <td>
                    <button class="btn btn-warning btn-sm nut-sua"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm nut-xoa"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
            </tbody>
        </table>
    </main>
</div>

<!-- === H·ªòP THO·∫†I TH√äM / S·ª¨A === -->
<div class="modal fade" id="hopThoaiKhuyenMai" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> C·∫≠p Nh·∫≠t Khuy·∫øn M√£i</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="bieuMauKhuyenMai" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">M√£ khuy·∫øn m√£i</label>
                        <input type="text" class="form-control" id="maKhuyenMai" placeholder="Nh·∫≠p m√£ khuy·∫øn m√£i">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">T√™n ch∆∞∆°ng tr√¨nh</label>
                        <input type="text" class="form-control" id="tenChuongTrinh" placeholder="Nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">M·ª©c gi·∫£m</label>
                        <input type="text" class="form-control" id="mucGiam" placeholder="VD: 20% ho·∫∑c 200000ƒë">
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-bold">Ph·∫°m vi √°p d·ª•ng (Ch·ªçn danh m·ª•c)</label>
                        <div id="dsDanhMuc" class="border rounded p-3 bg-light">
                            <div><input type="checkbox" value="Drone quay phim chuy√™n nghi·ªáp"> Drone quay phim chuy√™n nghi·ªáp</div>
                            <div><input type="checkbox" value="Drone du l·ªãch - vlog"> Drone du l·ªãch - vlog</div>
                            <div><input type="checkbox" value="Drone th·ªÉ thao t·ªëc ƒë·ªô cao"> Drone th·ªÉ thao t·ªëc ƒë·ªô cao</div>
                            <div><input type="checkbox" value="Drone n√¥ng nghi·ªáp"> Drone n√¥ng nghi·ªáp</div>
                            <div><input type="checkbox" value="Drone gi√°m s√°t - an ninh"> Drone gi√°m s√°t - an ninh</div>
                            <div><input type="checkbox" value="Drone mini - c·ª° nh·ªè"> Drone mini - c·ª° nh·ªè</div>
                            <hr>
                            <div><input type="checkbox" id="apDungTatCa" value="√Åp d·ª•ng t·∫•t c·∫£ danh m·ª•c"> √Åp d·ª•ng t·∫•t c·∫£ danh m·ª•c</div>
                            <div><input type="checkbox" id="khongApDung" value="Kh√¥ng √°p d·ª•ng danh m·ª•c"> Kh√¥ng √°p d·ª•ng danh m·ª•c</div>
                        </div>
                    </div>

                    <!-- √î nh·∫≠p ri√™ng m√£ s·∫£n ph·∫©m -->
                    <div class="col-12">
                        <label class="form-label fw-bold mt-2">M√£ s·∫£n ph·∫©m √°p d·ª•ng ri√™ng (n·∫øu c√≥)</label>
                        <input type="text" id="maSanPhamRieng" class="form-control" placeholder="VD: SP001, SP002">
                    </div>




                    <div class="col-md-6">
                        <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                        <input type="date" class="form-control" id="ngayBatDau">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Ng√†y k·∫øt th√∫c</label>
                        <input type="date" class="form-control" id="ngayKetThuc">
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button class="btn btn-primary">L∆∞u Thay ƒê·ªïi</button>
            </div>
        </div>
    </div>
</div>

<!-- === SCRIPT === -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function () {
        const bang = $('#bangKhuyenMai').DataTable({
            language: {
                lengthMenu: "Hi·ªÉn th·ªã _MENU_ khuy·∫øn m√£i",
                info: "Hi·ªÉn th·ªã _START_ - _END_ / _TOTAL_ khuy·∫øn m√£i",
                paginate: { previous: "Tr∆∞·ªõc", next: "Sau" },
                search: "T√¨m ki·∫øm:"
            }
        });

        // ===== N√öT L∆ØU THAY ƒê·ªîI =====
        $('.btn-primary').on('click', function () {
            const maKM = $('#maKhuyenMai').val().trim();
            const tenCT = $('#tenChuongTrinh').val().trim();
            const mucGiam = $('#mucGiam').val().trim();
            const ngayBD = $('#ngayBatDau').val();
            const ngayKT = $('#ngayKetThuc').val();

            // ‚úÖ L·∫•y danh m·ª•c ƒë∆∞·ª£c ch·ªçn
            let danhMuc = [];
            $('#dsDanhMuc input[type="checkbox"]:checked').each(function () {
                danhMuc.push($(this).val());
            });
            const phamVi = danhMuc.join(', ') || 'Kh√¥ng c√≥ danh m·ª•c n√†o';

            // L·∫•y m√£ s·∫£n ph·∫©m ri√™ng n·∫øu c√≥
            const maSanPham = $('#maSanPhamRieng').val().trim() || 'Kh√¥ng √°p d·ª•ng ri√™ng';

            if (!maKM || !tenCT) {
                alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }

            //  Ki·ªÉm tra xem m√£ khuy·∫øn m√£i ƒë√£ t·ªìn t·∫°i ch∆∞a
            let daCo = false;
            $('#bangKhuyenMai tbody tr').each(function () {
                if ($(this).find('td:first').text() === maKM) {
                    $(this).find('td:eq(1)').text(tenCT);
                    $(this).find('td:eq(2)').text(mucGiam);
                    $(this).find('td:eq(3)').text(`${ngayBD} - ${ngayKT}`);
                    $(this).find('td:eq(4)').text(phamVi + (maSanPham !== 'Kh√¥ng √°p d·ª•ng ri√™ng' ? ` (SP: ${maSanPham})` : ''));
                    daCo = true;
                }
            });

            // N·∫øu ch∆∞a c√≥ th√¨ th√™m m·ªõi
            if (!daCo) {
                $('#bangKhuyenMai tbody').append(`
            <tr>
                <td>${maKM}</td>
                <td>${tenCT}</td>
                <td>${mucGiam}</td>
                <td>${ngayBD} - ${ngayKT}</td>
                <td>${phamVi + (maSanPham !== 'Kh√¥ng √°p d·ª•ng ri√™ng' ? ` (SP: ${maSanPham})` : '')}</td>
                <td>
                    <button class="btn btn-warning btn-sm nut-sua"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm nut-xoa"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `);
            }

            $('#hopThoaiKhuyenMai').modal('hide');
            $('#bieuMauKhuyenMai')[0].reset();
            $('#dsDanhMuc input[type="checkbox"]').prop('checked', false);
            $('#maSanPhamRieng').val('');
        });

// ===== N√öT S·ª¨A =====
        $(document).on('click', '.nut-sua', function () {
            const dong = $(this).closest('tr');

            $('#maKhuyenMai').val(dong.find('td:eq(0)').text());
            $('#tenChuongTrinh').val(dong.find('td:eq(1)').text());
            $('#mucGiam').val(dong.find('td:eq(2)').text());
            const thoigian = dong.find('td:eq(3)').text().split(' - ');
            $('#ngayBatDau').val(thoigian[0]);
            $('#ngayKetThuc').val(thoigian[1]);

            // ‚úÖ X·ª≠ l√Ω tick danh m·ª•c l·∫°i
            const phamViText = dong.find('td:eq(4)').text();
            const maSPMatch = phamViText.match(/\(SP: (.+)\)/);
            const maSP = maSPMatch ? maSPMatch[1] : '';

            $('#maSanPhamRieng').val(maSP);

            // T√°ch danh m·ª•c tr∆∞·ªõc ph·∫ßn (SP: ...)
            const dmText = phamViText.split(' (SP:')[0].trim();
            const danhMucDaChon = dmText.split(',').map(s => s.trim());

            $('#dsDanhMuc input[type="checkbox"]').each(function () {
                $(this).prop('checked', danhMucDaChon.includes($(this).val()));
            });

            new bootstrap.Modal($('#hopThoaiKhuyenMai')).show();
        });

// ===== Checkbox logic ‚Äú√Åp d·ª•ng t·∫•t c·∫£‚Äù & ‚ÄúKh√¥ng √°p d·ª•ng‚Äù =====
        $('#apDungTatCa').on('change', function () {
            if (this.checked) {
                $('#dsDanhMuc input[type="checkbox"]').not(this).prop('checked', false);
            }
        });
        $('#khongApDung').on('change', function () {
            if (this.checked) {
                $('#dsDanhMuc input[type="checkbox"]').not(this).prop('checked', false);
            }
        });
        $('#dsDanhMuc input[type="checkbox"]').not('#apDungTatCa, #khongApDung').on('change', function () {
            $('#apDungTatCa, #khongApDung').prop('checked', false);
        });



// === Tu·ª≥ ch·ªânh √¥ t√¨m ki·∫øm m·∫∑c ƒë·ªãnh c·ªßa DataTables ===
        $('#bangKhuyenMai_filter input').addClass('form-control shadow-sm');
        $('#bangKhuyenMai_filter label').contents().filter(function() {
            return this.nodeType === 3; // xo√° text ‚ÄúT√¨m ki·∫øm:‚Äù
        }).remove();

// Th√™m icon üîç v√† style Bootstrap
        $('#bangKhuyenMai_filter').addClass('input-group justify-content-end');
        $('#bangKhuyenMai_filter input').wrap('<div class="input-group shadow-sm" style="max-width:300px;"></div>');
        $('#bangKhuyenMai_filter .input-group').prepend(`
    <span class="input-group-text bg-primary text-white">
        <i class="bi bi-search"></i>
    </span>
`);

        $('#bangKhuyenMai_filter input')
            .attr('placeholder', 'T√¨m ki·∫øm theo t√™n...')
            .css('min-width', '200px');



        //X·ª¨ L√ù CH·ªñ QU·∫¢N L√ù ƒê∆†N H√ÄNG X·ªî XU·ªêNG
        document.querySelectorAll('.has-submenu .menu-item').forEach(item => {
            item.addEventListener('click', () => {
                const parent = item.parentElement;
                parent.classList.toggle('open');
            });
        });


        // L·ªçc theo t√™n ch∆∞∆°ng tr√¨nh
        $('#nutLoc').on('click', function () {
            const tuKhoa = $('#oTimKiemKhuyenMai').val().toLowerCase();
            bang.rows().every(function () {
                const duLieu = this.data();
                const tenCT = (duLieu[1] || '').toLowerCase();
                if (tenCT.includes(tuKhoa) || tuKhoa === "") $(this.node()).show();
                else $(this.node()).hide();
            });
        });

        // N√∫t th√™m m·ªõi
        $('.nut-them').on('click', () => {
            $('#hopThoaiKhuyenMai .modal-title').text("üÜï Th√™m Khuy·∫øn M√£i");
            $('#bieuMauKhuyenMai')[0].reset();
        });

        // N√∫t s·ª≠a
        $(document).on('click', '.nut-sua', function () {
            const dong = $(this).closest('tr');
            $('#maKhuyenMai').val(dong.find('td:eq(0)').text());
            $('#tenChuongTrinh').val(dong.find('td:eq(1)').text());
            $('#mucGiam').val(dong.find('td:eq(2)').text());
            const thoigian = dong.find('td:eq(3)').text().split(' - ');
            $('#ngayBatDau').val(thoigian[0]);
            $('#ngayKetThuc').val(thoigian[1]);
            $('#phamVi').val(dong.find('td:eq(4)').text());
            new bootstrap.Modal($('#hopThoaiKhuyenMai')).show();
        });

        // N√∫t x√≥a
        $(document).on('click', '.nut-xoa', function () {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a khuy·∫øn m√£i n√†y kh√¥ng?")) {
                const dong = $(this).closest('tr');
                bang.row(dong).remove().draw(false);
            }
        });
    });


</script>
</body>
</html>
